<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加入計劃丨長堤城建</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/ionicons@5.5.2/dist/css/ionicons.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --platinum: #E5E4E2;
            --silver: #C0C0C0;
            --metal-accent: #6C757D;
            --obsidian: #0A0A0A;
            --success: #28a745;
            --error: #dc3545;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding-top: 80px;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.2rem 5%;
            backdrop-filter: saturate(180%) blur(20px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            color: var(--obsidian);
            letter-spacing: 1.2px;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: var(--metal-accent);
            text-decoration: none;
            font-weight: 500;
            position: relative;
            padding: 0.5rem 0;
            transition: color 0.3s ease;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--metal-accent);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .join-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .form-title {
            font-size: 2.2rem;
            color: var(--obsidian);
            margin-bottom: 1rem;
        }

        .form-subtitle {
            color: var(--metal-accent);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .input-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--metal-accent);
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border: 1px solid var(--silver);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--metal-accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(108,117,125,0.2);
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.8rem 1.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
        }

        .btn-primary {
            background: var(--metal-accent);
            color: white;
            border: none;
        }

        .btn-secondary {
            background: none;
            border: 1px solid var(--metal-accent);
            color: var(--metal-accent);
        }

        .progress-bar {
            height: 4px;
            background: rgba(108,117,125,0.1);
            margin-bottom: 2rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--metal-accent);
            transition: width 0.4s ease;
        }

        .review-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(108,117,125,0.05);
            border-radius: 6px;
        }

        .review-label {
            color: var(--metal-accent);
            font-weight: 500;
            margin-right: 1rem;
        }

        .loader {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .join-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="logo">長堤丨MCMTR</div>
            <div class="nav-links">
                <a href="/index.html" class="nav-link">首頁</a>
                <a href="#about" class="nav-link">計劃簡介</a>
                <a href="#stats" class="nav-link">實時數據</a>
                <a href="/login.html" class="nav-link">登入系統</a>
            </div>
        </div>
    </nav>

    <div class="join-container">
        <div class="progress-bar">
            <div class="progress-fill" style="width: 33%"></div>
        </div>

        <!-- 步骤1：基本信息 -->
        <div class="form-step active" data-step="1">
            <div class="form-header">
                <h2 class="form-title">加入建設團隊</h2>
                <p class="form-subtitle">請填寫基本資料，我們將在24小時內審核您的申請</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label class="input-label">Minecraft 用戶名</label>
                    <input type="text" class="input-field" id="username" required>
                </div>

                <div class="input-group">
                    <label class="input-label">電子信箱</label>
                    <input type="email" class="input-field" id="email" required>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="nextStep()">
                    下一步
                    <ion-icon name="arrow-forward-outline"></ion-icon>
                </button>
            </div>
        </div>

        <!-- 步骤2：详细信息 -->
        <div class="form-step" data-step="2">
            <div class="form-header">
                <h2 class="form-title">建設經驗</h2>
                <p class="form-subtitle">請分享您的城建經驗與專長領域</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label class="input-label">擅長領域</label>
                    <select class="input-field" id="specialty" required>
                        <option value="">請選擇...</option>
                        <option>交通規劃</option>
                        <option>建築設計</option>
                        <option>景觀美化</option>
                        <option>紅石工程</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">作品集連結</label>
                    <input type="url" class="input-field" id="portfolio">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">參與原因</label>
                <textarea class="input-field" id="motivation" rows="4" required></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                    上一步
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep()">
                    下一步
                    <ion-icon name="arrow-forward-outline"></ion-icon>
                </button>
            </div>
        </div>

        <!-- 步骤3：确认信息 -->
        <div class="form-step" data-step="3">
            <div class="form-header">
                <h2 class="form-title">確認申請</h2>
                <p class="form-subtitle">請確認以下資訊無誤後提交</p>
            </div>

            <div class="review-list">
                <div class="review-item">
                    <span class="review-label">用戶名:</span>
                    <span id="review-username"></span>
                </div>
                <div class="review-item">
                    <span class="review-label">電子郵件:</span>
                    <span id="review-email"></span>
                </div>
                <div class="review-item">
                    <span class="review-label">擅長領域:</span>
                    <span id="review-specialty"></span>
                </div>
            </div>

            <button type="button" class="btn btn-primary" id="submit-btn" onclick="submitForm()">
                <span id="submit-loader" style="display:none;">
                    <span class="loader"></span>
                </span>
                <span>確認提交</span>
            </button>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDP3SY__81TQwqJMB0gNmf6yMx1nyMXiaA",
            authDomain: "cheungticity.firebaseapp.com",
            databaseURL: "https://cheungticity-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cheungticity",
            storageBucket: "cheungticity.firebasestorage.app",
            messagingSenderId: "1030169122427",
            appId: "1:1030169122427:web:41f88f835ba43a0c19b4de",
            measurementId: "G-JWTDBWJH58"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentStep = 1;
        const formData = {};

        function updateProgress() {
            const progress = (currentStep / 3) * 100;
            document.querySelector('.progress-fill').style.width = `${progress}%`;
        }

        // 强化数据收集功能
        function collectFormData() {
            const steps = document.querySelectorAll('.form-step');
            
            steps.forEach(step => {
                const inputs = step.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.id) {
                        if (input.tagName === 'SELECT') {
                            formData[input.id] = input.options[input.selectedIndex].text;
                        } else {
                            formData[input.id] = input.value.trim();
                        }
                    }
                });
            });
        }

        // 完善验证逻辑
        function validateStep(step) {
            let isValid = true;
            const currentStepEl = document.querySelector(`[data-step="${step}"]`);
            
            // 清除旧错误提示
            currentStepEl.querySelectorAll('.error-msg').forEach(el => el.textContent = '');

            // 步骤1验证
            if (step === 1) {
                const username = formData.username;
                const email = formData.email;

                if (!username) {
                    showError('username', '請輸入Minecraft用戶名');
                    isValid = false;
                } else if (!/^[a-zA-Z0-9_]{3,16}$/.test(username)) {
                    showError('username', '用戶名需為3-16位英數組合');
                    isValid = false;
                }

                if (!email) {
                    showError('email', '請輸入電子信箱');
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showError('email', '電子信箱格式不正確');
                    isValid = false;
                }
            }

            // 步骤2验证
            if (step === 2) {
                if (!formData.specialty || formData.specialty === '請選擇...') {
                    showError('specialty', '請選擇擅長領域');
                    isValid = false;
                }

                if (formData.portfolio && !isValidUrl(formData.portfolio)) {
                    showError('portfolio', '請輸入有效的網址');
                    isValid = false;
                }

                if (!formData.motivation) {
                    showError('motivation', '請填寫參與原因');
                    isValid = false;
                } else if (formData.motivation.length < 50) {
                    showError('motivation', '請輸入至少50字說明');
                    isValid = false;
                }
            }

            return isValid;
        }

        // 步骤切换控制
        function nextStep() {
            collectFormData();
            if (!validateStep(currentStep)) return;

            // 更新确认页面显示
            if (currentStep === 2) {
                document.getElementById('review-username').textContent = formData.username || '未填寫';
                document.getElementById('review-email').textContent = formData.email || '未填寫';
                document.getElementById('review-specialty').textContent = formData.specialty || '未選擇';
            }

            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
            currentStep++;
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();
        }

        function prevStep() {
            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
            currentStep--;
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();
        }

        // 表单提交处理
        async function submitForm() {
            const submitBtn = document.getElementById('submit-btn');
            const loader = document.getElementById('submit-loader');
            
            try {
                submitBtn.disabled = true;
                loader.style.display = 'inline-block';

                // 最终数据验证
                collectFormData();
                if (!validateStep(1) || !validateStep(2)) {
                    throw new Error('請先完成所有必填欄位');
                }

                // 构建提交数据
                const submissionData = {
                    minecraft_id: formData.username,
                    email: formData.email,
                    specialty: formData.specialty,
                    portfolio: formData.portfolio || '',
                    motivation: formData.motivation,
                    submission_time: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending-review',
                    ip_address: await getClientIP()
                };

                // 防重复提交检查
                const sessionKey = `submitted_${formData.email}`;
                if (sessionStorage.getItem(sessionKey)) {
                    throw new Error('同個電子信箱24小時內只能提交一次申請');
                }

                // 写入Firestore
                const docRef = await db.collection('applications').add(submissionData);
                
                // 写入Realtime Database
                await firebase.database().ref(`submissions/${docRef.id}`).update({
                    last_updated: Date.now(),
                    progress: 0,
                    ...submissionData
                });

                sessionStorage.setItem(sessionKey, 'true');
                window.location.href = `/join-success.html?id=${docRef.id}`;

            } catch (error) {
                console.error('提交失敗:', error);
                alert(`提交失敗：${error.message}`);
                currentStep = 1;
                updateProgress();
                document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
                document.querySelector('[data-step="1"]').classList.add('active');
            } finally {
                submitBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        // 实用工具函数
        function showError(fieldId, message) {
            const errorEl = document.getElementById(fieldId).closest('.input-group').querySelector('.error-msg');
            errorEl.textContent = message;
            errorEl.style.color = '#dc3545';
        }

        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }
    </script>
    <script>
        // 初始化后添加匿名登录
        const auth = firebase.auth();
        
        // 匿名登录函数
        async function initializeAuth() {
            try {
                await auth.signInAnonymously();
                console.log('匿名登录成功');
            } catch (error) {
                console.error('匿名登录失败:', error);
            }
        }
    
        // 修改后的提交函数
        async function submitForm() {
            try {
                // 检查登录状态
                if (!auth.currentUser) {
                    await initializeAuth();
                }
    
                // 获取用户Token
                const idToken = await auth.currentUser.getIdToken();
    
                // 发送数据时携带Token
                const docRef = await db.collection('applications').add({
                    ...submissionData,
                    _auth: idToken  // 添加验证令牌
                });
            } catch (error) {
                console.error('提交失敗:', error);
            }
        }
    </script>
    
</body>
</html>
