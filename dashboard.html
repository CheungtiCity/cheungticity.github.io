<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理中樞丨長堤城建</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --silver-primary: #e0e0e0;
            --silver-secondary: #f8f9fa;
            --metal-accent: #6c757d;
            --admin-red: #dc3545;
        }

        body {
            background: linear-gradient(135deg, var(--silver-secondary) 0%, var(--silver-primary) 100%);
            min-height: 100vh;
            margin: 0;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-title {
            font-size: 1.8rem;
            color: var(--metal-accent);
            letter-spacing: 1px;
        }

        .logout-btn {
            background: var(--admin-red);
            color: white;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            color: var(--metal-accent);
            border-bottom: 2px solid var(--silver-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .server-status {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .online { background: #28a745; }
        .offline { background: var(--admin-red); }
    </style>
     <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDP3SY__81TQwqJMB0gNmf6yMx1nyMXiaA",
            authDomain: "cheungticity.firebaseapp.com",
            projectId: "cheungticity",
            storageBucket: "cheungticity.appspot.com",
            messagingSenderId: "1030169122427",
            appId: "1:1030169122427:web:41f88f835ba43a0c19b4de"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const db = firebase.firestore();

        // 页面加载时立即检查
        document.addEventListener('DOMContentLoaded', () => {
            initAuthCheck();
            setupInactivityTimer(300); // 5分钟无操作自动登出
        });

        // 认证状态检查
        function initAuthCheck() {
            auth.onAuthStateChanged(async user => {
                try {
                    if (!user) {
                        redirectToLogin();
                        return;
                    }

                    // 验证管理員权限
                    const isAdmin = await checkAdminPrivilege(user.uid);
                    if (!isAdmin) {
                        showAccessDenied();
                        await auth.signOut();
                        return;
                    }

                    // 权限通过后加载内容
                    loadDashboardContent();
                } catch (error) {
                    console.error('权限验证失败:', error);
                    handleAuthError(error);
                }
            });
        }

        // 管理员权限验证
        async function checkAdminPrivilege(uid) {
            try {
                const doc = await db.collection('admins').doc(uid).get();
                return doc.exists;
            } catch (error) {
                console.error('权限检查错误:', error);
                return false;
            }
        }

        // 加载仪表盘内容
        async function loadDashboardContent() {
            document.body.style.display = 'block'; // 显示页面内容
            try {
                await Promise.all([
                    loadServerStatus(),
                    loadUserList(),
                    setupRealtimeUpdates()
                ]);
            } catch (error) {
                console.error('数据加载失败:', error);
                showPersistentError('數據加載失敗，請刷新頁面');
            }
        }

        // 无权限处理
        function showAccessDenied() {
            alert('存取拒絕：您的帳戶沒有管理員權限');
            redirectToLogin();
        }

        // 错误处理
        function handleAuthError(error) {
            const errorMap = {
                'permission-denied': '資料庫權限不足',
                'network-error': '網路連接失敗'
            };
            const message = errorMap[error.code] || '系統發生錯誤';
            showPersistentError(message + '，即將跳轉至登入頁');
            setTimeout(redirectToLogin, 3000);
        }

        // 登出功能
        async function logout() {
            try {
                await auth.signOut();
                redirectToLogin();
            } catch (error) {
                console.error('登出失敗:', error);
                showPersistentError('登出失敗，請手動清除瀏覽器快取');
            }
        }

        // 跳转至登录页
        function redirectToLogin() {
            window.location.replace('https://cheungticity.github.io/login');
        }

        // 其他数据加载函数保持不变...
    </script>
</head>
<body style="display:none;"> <!-- 初始隐藏页面 -->
<body>
    <div class="admin-header">
        <div class="dashboard-title">長堤城建管理系統 v2.1</div>
        <div class="logout-btn" onclick="logout()">登出系統</div>
    </div>

    <div class="dashboard-grid">
        <!-- 服務器狀態 -->
        <div class="admin-card">
            <h2 class="card-title">伺服器監控</h2>
            <div id="serverStatus"></div>
        </div>

        <!-- 用戶管理 -->
        <div class="admin-card">
            <h2 class="card-title">用戶管理</h2>
            <div id="userList"></div>
        </div>

        <!-- 操作日誌 -->
        <div class="admin-card">
            <h2 class="card-title">即時日誌</h2>
            <div id="activityLogs"></div>
        </div>
    </div>

    <script>
        // Firebase 初始化
        const firebaseConfig = { /* 你的配置信息 */ };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const db = firebase.firestore();

        // 權限驗證
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            // 驗證管理員權限
            const userDoc = await db.collection('admins').doc(user.uid).get();
            if (!userDoc.exists) {
                alert('權限不足');
                auth.signOut();
                return;
            }

            // 加載儀表板數據
            loadServerStatus();
            loadUserList();
            setupRealtimeUpdates();
        });

        // 服務器狀態
        async function loadServerStatus() {
            const snapshot = await db.collection('server_status').get();
            let html = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="server-status">
                        <div class="status-indicator ${data.online ? 'online' : 'offline'}"></div>
                        ${data.name} - ${data.load}%
                    </div>
                `;
            });
            document.getElementById('serverStatus').innerHTML = html;
        }

        // 用戶列表
        async function loadUserList() {
            const snapshot = await db.collection('users').limit(10).get();
            let html = '';
            snapshot.forEach(doc => {
                const user = doc.data();
                html += `<div>${user.displayName} <small>${user.email}</small></div>`;
            });
            document.getElementById('userList').innerHTML = html;
        }

        // 即時監聽
        function setupRealtimeUpdates() {
            db.collection('activity_logs')
                .orderBy('timestamp', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    let logs = '';
                    snapshot.forEach(doc => {
                        const log = doc.data();
                        logs += `<div>[${new Date(log.timestamp).toLocaleString()}] ${log.action}</div>`;
                    });
                    document.getElementById('activityLogs').innerHTML = logs;
                });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/login.html';
            });
        }
    </script>
</body>
</html>
